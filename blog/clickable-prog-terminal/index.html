<!doctype html><html lang=en><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.74.2"><title>在 Linux Terminal 中實作一個可以點的程式 • jw910731's Blog</title><meta name=twitter:card content="summary"><meta name=twitter:title content="在 Linux Terminal 中實作一個可以點的程式"><meta name=twitter:description content="記錄我在 Linux Terminal 中實作一個可以接收滑鼠事件的程式的路程與心得"><meta property="og:title" content="在 Linux Terminal 中實作一個可以點的程式"><meta property="og:description" content="記錄我在 Linux Terminal 中實作一個可以接收滑鼠事件的程式的路程與心得"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jw910731.wtf/blog/clickable-prog-terminal/"><meta property="article:published_time" content="2020-12-07T23:04:49+08:00"><meta property="article:modified_time" content="2020-12-07T23:04:49+08:00"><meta property="og:site_name" content="jw910731's Blog"><link rel=stylesheet href=/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://blog.jw910731.wtf/>jw910731's Blog</a></span><div class=author-image><img src="https://www.gravatar.com/avatar/3b8585910e02580ed8fbf57c1052bedc?s=240&d=mp" class="img--circle img--headshot element--center" alt=gravatar></div><p class=site__description>一個 CSIE 學生胡搞瞎搞的地方</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>jw910731's Blog</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/blog><span>Blog</span></a></li><li><a href=/course><span>Course</span></a></li></ul></div><section class=social><a href=https://facebook.com/jw910731 rel=me><i class="fab fa-facebook-f"></i></a><a href=https://github.com/jw910731 rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a><a href=https://bitbucket.org/jw910731 rel=me><i class="fab fa-bitbucket fa-lg" aria-hidden=true></i></a><a href=https://gitlab.com/jw910731 rel=me><i class="fab fa-gitlab fa-lg" aria-hidden=true></i></a><a href=https://stackoverflow.com/users/11264533/jw910731 rel=me><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a><a href=mailto:jw910731@gmail.com rel=me><i class="fas fa-at fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2020 jw910731</div><div class=builtwith>Built with <a href=https://gohugo.io>Hugo</a> ❤️ <a href=https://github.com/htr3n/hyde-hyde>hyde-hyde</a>.</div></div></div><div class="content container"><article><header><h1>在 Linux Terminal 中實作一個可以點的程式</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>2020/12/12<br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/computer-programming-i>computer programming i</a>
<a class="badge badge-tag" href=/tags/%E5%BF%83%E5%BE%97>心得</a>
<a class="badge badge-tag" href=/tags/%E5%B8%AB%E5%A4%A7>師大</a><br><i class="fas fa-clock"></i>1 min read</div></header><div class=post><h1 id=前記>前記</h1><p>感謝超邪惡的程設老師跟我下戰帖，說：「我能寫出來的話，他就敢叫助教給我分」，我就趁著這股幹勁把東西弄出來了！</p><p>也感謝 StackOverflow 與<a href=https://shyuanliang.blogspot.com/2010/09/>這篇資料</a>，他們在指引我將 tty 做 Non-Canonical Input 的部分有了很大的功勞，讓我不會啃文件過勞死 QwQ 。</p><h2 id=前情提要>前情提要</h2><p>程設課這次的作業 ( hw0505 ) 是一個正常的踩地雷，要支援插旗功能，輸入以輸入座標來表達。我怎麼想怎麼覺得奇怪，踩地雷輸入座標也太難玩了吧，不是應該要支援點擊輸入才好嗎？我向老師提出這個想法，他居然回我「你如果寫出來我就叫助教給你分」，就衝著這個句話我就寫出來了這隻程式了！</p><h1 id=大冒險開始>大冒險開始</h1><h2 id=啃文件>啃文件</h2><h3 id=xterm-control-sequence>Xterm Control Sequence</h3><p>我首先遇到的問題是「如何讓 terminal 回報滑鼠事件」，所有的資料都導向<a href=https://invisible-island.net/xterm/ctlseqs/ctlseqs.pdf>這篇 Xterm Control Sequence 文件</a>，我乾啃文件啃了快要 2 小時即將吐血之際，我轉而投靠 Google 大法，在 StackOverflow 上面找到了讓 Terminal 依照指定標準回報滑鼠行為的 ASCII Escape 。</p><h3 id=termiosh>termios.h</h3><p>我趁著這股幹勁，試著印出 Terminal 回報回來的滑鼠行為，卻遇到問題了，linux 的 stdin 是 line buffered 的，我本來試著停止 C 語言的 IO Buffer 但並未造成期待的結果。在使用 <code>gdb</code> 做中斷後，才發現 <code>read</code> 這個 system call 在遇到 newline 字元時才會將控制權交回主程式，這代表我必須跟系統好好談談才行。</p><p>我找了快要1小時的資料才找到 <code>termios.h</code> 這個函數庫，可以將指定的 tty / stty 轉換成 serial input ，並可以關閉 <code>read </code>以 newline 字元為 flush 輸入流時機點的功能。我便開始啃 <code>termios.h</code> 的 manpage ，但啃了半個小時快放棄時，才想到之前乾啃官方文件的失敗經驗，立刻 Google 找別人的精華文，並順便偷 example code 做實驗，這個方法讓我在 1 小時後得到了豐厚的成果，我已經可以順利捕捉到滑鼠行為，並著手撰寫相對應的抽象層，方便我後續程式的撰寫！</p><h2 id=實作大冒險-w>實作大冒險 >w&lt;</h2><p>最一開始實作的其實是有關 <code>termios.h</code> 相關的實作，大部分都是從偷來的 example code 為基礎作修改，主要的問題是物件生命週期的掌握，我後來為了方便起見，大量使用 <code>static</code> 的 <code>struct</code> 全域變數來管理物件生命週期並避免命名污染！並且為了 terminal 不要在我程式結束後繼續傳送滑鼠事件到 stdin ，我也做了 <code>signal</code> 的 syscall 與 <code>atexit</code> 的呼叫來使正常與非正常終止時都能呼叫到停止 terminal 傳送滑鼠事件的 callback ！</p><p>接著我開始實作自己的滑鼠事件接收抽象層，我實作了一個監聽器的 pattern ，在開始監聽時要求傳入一組含由 function pointer 組成的 <code>struct</code> ，用來描述遇到不同行為的 callback ，滑鼠事件觸發在此圓滿落幕！</p><p>我開始寫掃地雷的程式，有別於之前管理物件生命週期保守的做法，我大量使用指標與使用 Heap 空間的記憶體來降低耦合並增加彈性 ( 因為前幾段 code 都是要啃很多文件，但程式事實上的需求簡單，反觀此段需求比較複雜，耦合度不可以太高，不然會除蟲除到死 )。踩地雷場地儲存的部分因為我懶，我把所有資料以<strong>位元壓縮</strong>壓在一個 <code>int32_t</code> 裡面，方便擴增也免除複雜的記憶體管理問題。 ( 雖然後來只用了 7 個bit )</p><p>然後我速刻了一個 double linked list 來做我 BFS 的 queue 實作，無奈如同原始人般的 C 語言連 queue 這種基本的東西都要手刻啊 QQQQQQQ 。小心翼翼地檢查了記憶體的釋放，卻還是有些頭尾節點紀錄上的問題出現，發掘並除錯後，程式大致上大功告成！</p><h1 id=後記>後記</h1><p>經過約 2 小時的細部微調與美化後，我終於算是正式完工了可以用滑鼠互動點擊的踩地雷遊戲，不得不說還蠻有成就感的。雖然腳因為 2 天都長時間坐在椅子上啃文件，出了點問題就是了 QwQ ，這個作品可說是用我的一條腿犧牲召喚而來的啊 ( 誤</p><p>寫這隻程式時也真心感覺到 Sanitizer 真的是太好用了，如果這次沒有開 Sanitizer ，我可能又要再多通靈 2 天才能寫出來囉 QwQ</p><h2 id=成果炫耀-->成果炫耀 ( ?</h2><p>這裡是<a href=https://github.com/jw910731/computer-programming/tree/I/hw05>原始碼傳送門</a>， build 出來的 hw0505 就是這個神奇的程式了。不過目前因為 Mac 上好像只支援 SGR 的滑鼠事件格式而我懶的繼續寫了，所以目前是只能在 Linux 下的 Terminal 模擬器裡面正常運作的， Mac 可以成功建構但聽不到滑鼠事件 QQ 。想讓它支援的應該啃啃文件，讀讀我的 code 應該不難支援才對！</p></div><div class="navigation navigation-single"><a href=/blog/cmake-link-fail-2020-11-10/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i><span class=navigation-tittle>Cmake Link Failed on Mac OS X</span></a></div><div id=graphcomment></div><script type=text/javascript>window.graphcomment_id='Jw910731-blog';(function(){var gc=document.createElement('script');gc.type='text/javascript';gc.async=true;gc.src='https://graphcomment.com/js/integration.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(gc);})();</script></article></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-178403196-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://use.fontawesome.com/releases/v5.12.1/js/all.js integrity=sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR crossorigin=anonymous></script></body></html>